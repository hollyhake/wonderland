--- 
title: "Tracking memory decline"
author: "Holly Hake"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(magrittr)
library(ggplot2)
library(ggthemes)
library(ppcor)
library(reshape2)
#library(gglasso)
library(glmnet)
library(ggsci)
library(viridis)
library(ggExtra)
library(kableExtra)
library(xtable)
library(ggrepel)
library(scales)
library(car)
library(patchwork)      # Multi-plot alignment
#library(data.table)
library(ggcorrplot)
library(readr)
library(gapminder) # dataset used to make the box plot connected by lines
#theme_set(theme_bw(16)) # theme used to make the box plot connected by lines
library(RColorBrewer)
library(plotly) # Added to make interactive graphs 
library(lubridate) # Added to make interactive graphs; use different date funcs
library(stringr) # Added to make interactive graphs; use different txt funcs
library(extrafont) # Added to make interactive graphs; change font on graphs
library(htmlwidgets) # Added to make interactive graphs; make exports interactive
library(broom)
library(cowplot)

# Install SlimStampen packages. Instructions on https://github.com/VanRijnLab/SlimStampeRData
#install.packages("devtools")
library(devtools)
#devtools::install_github("VanRijnLab/SlimStampeRData",
                      #   build_vignettes = TRUE,
                       #  dependencies = TRUE,
                        # force = TRUE) 
# The console will show a prompt asking whether all packages should be updated. Select option 1 (by typing 1 and then pressing enter), this will update all packages.
vignette("SlimStampeRVignette")
library(SlimStampeRData)
```



# Introduction

## Goal
The goal of this project is to track memory decline in Alzheimerâ€™s disease and dementia using the model-based, adaptive SlimStampen system. This markdown file contains visualizations of Rates of Forgetting.

## Background
Memory loss is a debilitating symptom of neurodegenerative diseases. Current assessment tools, however, lack the reliable, convenient, and repeatable qualities needed to capture the individualized and evolving nature of memory decline. This project uses neurocomputational models to track and predict memory decline in subjectively- or mildly-cognitively impaired (MCI) individuals. MCI = Functional capacity is relatively intact, but on objective testing, show cognitive decline in at least one area of neuropsychological functioning.

## Rate of Forgetting


# Methods 

## Participants 

## Memory Task

# Results
```{r, echo=FALSE, results= 'hide'}

# Load data
load("C:/Users/17203/Documents/GitHub/Blaarkop/data/SlimStampen_2022-07-26.RData")

# Set path for figures 
path <- "C:/Users/17203/Desktop/Memory/Data"

# Filter for just ADRC subjects & group by clinical status
groups <- read_csv("C:/Users/17203/Documents/GitHub/Blaarkop/groups.csv", show_col_types = FALSE)
data %>% 
  filter(userId %in% groups$userId) -> data

```

```{r, echo=FALSE, results= 'hide'}

# Calculate fact rep, activation, and alpha 
MAX_ALPHA = 0.8
data <- data %>%
  calculate_repetition() %>%
  calculate_alpha_and_activation(maxAlpha = MAX_ALPHA)


# Calculate avg alpha
data_lastRep <- data %>%
  group_by(lessonId, userId, sessionId, factId) %>%
  mutate(LastRepetition = max(repetition)) %>%
  filter(repetition == LastRepetition) %>%
  ungroup()

data_avg1 <- data_lastRep %>%
  group_by(userId, lessonTitle, lessonId, sessionId) %>%
  summarise(MeanAlpha = mean(alpha), MedianAlpha = median(alpha)) 

data_avg2 <- data %>%
  group_by(lessonId, userId, sessionId) %>%
  summarise(correct = mean(correct), responseTime=mean(reactionTime)) %>%
  ungroup()

data_avg <- data_avg1 %>% inner_join(data_avg2)

data_avg %>% 
  group_by(userId, lessonTitle, lessonId) %>% 
  summarize(numSess=length(unique(sessionId))) 


# Filter the sessions
sessionData <- data %>% 
  group_by(userId, sessionId, lessonId, lessonTitle) %>% 
  summarize(duration = (max(presentationStartTime) - min(presentationStartTime))/60000,
            start = min(presentationStartTime),
            legit = if_else(duration > 6, T, F))

sessionData <- sessionData %>% 
  group_by(userId, lessonId, lessonTitle) %>% 
  arrange(start, by_group=T) %>%
  mutate(sessionRank = seq(1, length(start)))

sessionDataFiltered <- sessionData %>%
  filter(legit == T) %>%
  group_by(userId, lessonId) %>%
  mutate(minRank = min(sessionRank))

sessionData <- sessionData %>%
  inner_join(sessionDataFiltered) %>%
  mutate(usable = if_else(minRank == sessionRank, T, F))


# Group by clinical status
clinical <- inner_join(data_avg, groups) %>%
  inner_join(sessionData) %>%
  filter(usable == T)

clinical %>% 
  group_by(lessonTitle, clinicalStatus) %>% 
  summarise(n=length(userId)) %>%
  pivot_wider(names_from=clinicalStatus, values_from = n) %>%
  xtable() %>%
  kable(digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))


clinical$userId <- as.character(clinical$userId)
clinical <- clinical %>%
  mutate(paired= factor(userId))

# Order the lessons by week
level_order<- factor(clinical$lessonTitle, level = c('01 Practice','Pasta','Swahili 1','Flowers','European Capitals 1','Birds', 'Newspapers'))


```
## Accuracy

The averaged accuracy for each participant across all lessons. 

```{r,echo=FALSE, fig.height=8, fig.width=18, results= 'hide'}

# All subjects

graph.clinical = ggplot(clinical, aes(x=level_order, y=correct, col=lessonTitle, fill=lessonTitle
                    ))+
  geom_violin(width=1, alpha =0.2) +
  #geom_boxplot(width=.5, alpha =0.2)+
  #stat_summary(fun.y=mean, geom="pointrange", size=0.3, shape= 1, color="black")+
  geom_point(size = 2, position = position_jitter(0.1)) +
  #scale_color_viridis("lessonTitle", option = "plasma") +
  xlab("Lesson") +
  ylab("Accuracy") +
  ylim(0.25,1.0)+
  ggtitle("Average Accuracy for Each Lesson") +
  theme_pander() +
  theme(#panel.grid.major.y = element_blank(),
        #panel.grid.major.x = element_blank(),
        #panel.grid.minor.y = element_blank(),
        legend.position = "none")

ggplotly(graph.clinical, tooltip = c("y", "text"), height = 450, width = 800) %>% 
  config(displayModeBar= FALSE)

```

This graph lets you interact with the data points to get a better look at the
accuracy scores for each of the individual subjects.

```{r, AVG Individual accuracy-|-Line, fig.height=8, fig.width=18, echo=FALSE}

# Individual
graph.clinical = ggplot(clinical, aes(x=level_order, y=correct,
                                              text=paste0(userId)))+
  geom_boxplot(size =0.5) +
  geom_line(aes(group=paired), size=0.2, position = position_dodge(0))+
  geom_point(aes(fill=userId, group=paired), size=3, shape=20, stroke = 0, position = position_dodge(0))+
  scale_color_viridis(alpha= 0.1,"correct", option = "plasma") +
  xlab("Lesson") +
  ylab("Accuracy") +
  ylim(0.25,1.0)+
  ggtitle("Average Accuracy for Each Lesson (individual)") +
  theme_pander() +
  theme(legend.position = "right",
        legend.title = element_text("Subject"),
        panel.grid.major = element_blank())

ggplotly(graph.clinical, tooltip = c("y", "text"), height = 450, width = 800) %>% 
  config(displayModeBar= FALSE)

```

This graph separates the subjects by clinical status. 

```{r, AVG accuracy-|-Line,echo=FALSE}


cvpalette <- c('#522888','#66369D','#967BB6','CDC7D9','#BF9553','#B97F24')

# Group
graph.clinical = ggplot(clinical, aes(x=level_order, y=correct,col = clinicalStatus, fill = clinicalStatus,
                                              text=paste0(userId)))+
  geom_boxplot(size =0.5, alpha =0.1) +
  geom_line(aes(group=paired), size=0.2, position = position_dodge(0))+
  geom_point(aes(fill=clinicalStatus, group=paired), size=3, shape=20, stroke = 0, position = position_dodge(0))+
  #scale_fill_manual(values=cvpalette)+
  #scale_color_viridis(discrete=TRUE, option = "magma",alpha=0.5) +
  xlab("Lesson") +
  ylab("Accuracy") +
  ylim(0.25,1.0)+
  ggtitle("Average Accuracy for Each Lesson (Clinical Status)") +
  theme(legend.position = "right",
        legend.title = element_text("Subject"),
        panel.grid.major = element_blank())+
  theme_pander()


ggplotly(graph.clinical, tooltip = c("y", "text"), height = 450, width = 800) %>% 
  config(displayModeBar= FALSE)

```

## Rate of Forgetting 

The averaged Rate of Forgetting for each participant across all lessons. 

```{r,echo=FALSE, results= 'hide'}

# All subjects

ggplot(clinical, aes(x=level_order, y=MeanAlpha, col=lessonTitle, fill=lessonTitle
                    ))+
  geom_violin(width=2, alpha =0.2) +
  #geom_boxplot(width=.5, alpha =0.2)+
  #stat_summary(fun.y=mean, geom="pointrange", size=0.3, shape= 1, color="black")+
  geom_point(size = 3, position = position_jitter(0.1)) +
  #scale_color_viridis("lessonTitle", option = "plasma") +
  xlab("Lesson") +
  ylab("RoF") +
  ylim(0.1,0.5)+
  ggtitle("Average RoF for Each Lesson") +
  theme_pander() +
  theme(#panel.grid.major.y = element_blank(),
        #panel.grid.major.x = element_blank(),
        #panel.grid.minor.y = element_blank(),
        legend.position = "none")

```


As you can see, individuals with Mild Cognitive Impairment (MCIs) tend to have 
a higher Rate of Forgetting than the age-matched controls. 

```{r, AVG Alpha Mean-|-Line, fig.height=8, fig.width=18, echo=FALSE}


# Group
graph.clinical = ggplot(clinical, aes(x=level_order, y=MeanAlpha,col = clinicalStatus, fill = clinicalStatus,
                                              text=paste0(userId)))+
  geom_boxplot(size =0.5,alpha =0.1) +
  geom_line(aes(group=paired), size=0.2, position = position_dodge(0))+
  geom_point(aes(fill=clinicalStatus, group=paired), size=3, shape=20, stroke = 0, position = position_dodge(0))+
  #scale_color_viridis("MeanAlpha", option = "plasma") +
  xlab("Lesson") +
  ylab("Rate of Forgetting (Mean Alpha)") +
  ggtitle("Rate of Forgetting by Clinical Status (Mean)") +
  theme_pander() +
  theme(legend.position = "right",
        legend.title = element_text("Subject"),
        panel.grid.major = element_blank())

ggplotly(graph.clinical, tooltip = c("y", "text"), height = 450, width = 800) %>% 
  config(displayModeBar= FALSE)



# Individual
graph.clinical = ggplot(clinical, aes(x=level_order, y=MeanAlpha,
                                              text=paste0(userId)))+
  geom_boxplot(size =0.5) +
  geom_line(aes(group=paired), size=0.2, position = position_dodge(0))+
  geom_point(aes(fill=userId, group=paired), size=3, shape=20, stroke = 0, position = position_dodge(0))+
  scale_color_viridis("MeanAlpha", option = "plasma") +
  xlab("Lesson") +
  ylab("Rate of forgetting (Mean Alpha)") +
  ggtitle("Rate of Forgetting Per Participant (Mean)") +
  theme_pander() +
  theme(legend.position = "right",
        legend.title = element_text("Subject"),
        panel.grid.major = element_blank())

ggplotly(graph.clinical, tooltip = c("y", "text"), height = 450, width = 800) %>% 
  config(displayModeBar= FALSE)

```

```{r, fig.height=8, fig.width=5, echo=FALSE}
ggplot(clinical, aes(y = MeanAlpha, x = level_order, col = clinicalStatus,
                     fill = clinicalStatus)) +
  #geom_boxplot() +
  #stat_summary(geom="errorbar", fun.data = "mean_se", width=0.1) +
  stat_summary(geom="point", fun.data = "mean_sdl", size=3) +
  stat_summary(geom="ribbon", fun.data = "mean_se", 
               aes(group=clinicalStatus), 
               col=NA,
               alpha=0.25) +
  stat_summary(geom="line", fun = "mean", aes(group = clinicalStatus)) +
  scale_color_d3() +
  scale_fill_d3() +
  xlab("Lesson") +
  ylab("Mean Rate of Forgetting") +
  ggtitle("Rate of Forgetting By Clinical Status") +
  labs(col="Clinical Status", fill="Clinical Status") +
  theme(axis.text.x = element_text(angle = 0, vjust = 1, hjust=1))+
  theme_pander()
  
```
  
  
  ```{r}
  
  ```
